<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2D/3D Physics Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
    }
    
    .container {
      width: 95%;
      max-width: 1400px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    
    button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    button.active {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.6);
    }
    
    .canvas-container {
      position: relative;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    .stats {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      backdrop-filter: blur(5px);
    }
    
    .info {
      text-align: center;
      margin-top: 20px;
      opacity: 0.8;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
    }
    
    .error {
      text-align: center;
      padding: 30px;
      background: rgba(255, 0, 0, 0.2);
      border-radius: 10px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ Physics Engine Demo</h1>
    <p class="subtitle">2D & 3D Unified Physics Simulation</p>
    
    <div id="loading" class="loading">
      Loading UnifiedPhysicsEngine.js...
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="main" style="display: none;">
      <div class="controls">
        <button id="btn2D" class="active">2D Mode</button>
        <button id="btn3D">3D Mode</button>
        <button id="btnAddCircle">Add Circle/Sphere</button>
        <button id="btnAddBox">Add Box</button>
        <button id="btnReset">Reset Scene</button>
        <button id="btnPause">Pause</button>
      </div>
      
      <div class="canvas-container">
        <canvas id="canvas" width="1200" height="700"></canvas>
        <div class="stats">
          <div>Mode: <span id="statMode">2D</span></div>
          <div>Bodies: <span id="statBodies">0</span></div>
          <div>FPS: <span id="statFPS">60</span></div>
          <div>Substeps: <span id="statSubsteps">4</span></div>
        </div>
      </div>
      
      <div class="info">
        üí° Click on canvas to add objects ‚Ä¢ Drag to throw objects
      </div>
    </div>
  </div>

  <script src="UnifiedPhysicsEngine.js"></script>
  <script>
    // „Ç®„É≥„Ç∏„É≥„ÅÆ„É≠„Éº„ÉâÁ¢∫Ë™ç
    window.addEventListener('load', () => {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const main = document.getElementById('main');
      
      if (typeof UnifiedPhysics === 'undefined') {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.innerHTML = `
          <h3>‚ö†Ô∏è UnifiedPhysicsEngine.js „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h3>
          <p>Âêå„Åò„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ UnifiedPhysicsEngine.js „ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        `;
        return;
      }
      
      loading.style.display = 'none';
      main.style.display = 'block';
      
      // „Éá„É¢„ÅÆÂàùÊúüÂåñ
      initDemo();
    });
    
    function initDemo() {
      const { Vec2, Vec3, Body, PhysicsWorld } = UnifiedPhysics;
      
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      let mode = '2D';
      let world = new PhysicsWorld('2D', { substeps: 4, maxIters: 8 });
      let isPaused = false;
      let mouseDown = false;
      let mouseStart = null;
      let lastTime = performance.now();
      let fps = 60;
      
      // UIË¶ÅÁ¥†
      const btn2D = document.getElementById('btn2D');
      const btn3D = document.getElementById('btn3D');
      const btnAddCircle = document.getElementById('btnAddCircle');
      const btnAddBox = document.getElementById('btnAddBox');
      const btnReset = document.getElementById('btnReset');
      const btnPause = document.getElementById('btnPause');
      
      // 2D„Ç∑„Éº„É≥„ÅÆÂàùÊúüÂåñ
      function init2D() {
        mode = '2D';
        world = new PhysicsWorld('2D', { 
          gravity: new Vec2(0, 980),
          substeps: 4,
          maxIters: 8
        });
        
        // Âú∞Èù¢
        world.addBody(new Body({
          dim: '2D',
          type: 'box',
          pos: new Vec2(600, 650),
          halfWidth: 600,
          halfHeight: 50,
          static: true,
          restitution: 0.3
        }));
        
        // Â£Å
        world.addBody(new Body({
          dim: '2D',
          type: 'box',
          pos: new Vec2(50, 350),
          halfWidth: 50,
          halfHeight: 350,
          static: true,
          restitution: 0.3
        }));
        
        world.addBody(new Body({
          dim: '2D',
          type: 'box',
          pos: new Vec2(1150, 350),
          halfWidth: 50,
          halfHeight: 350,
          static: true,
          restitution: 0.3
        }));
        
        // Êñú„ÇÅ„ÅÆÂè∞
        world.addBody(new Body({
          dim: '2D',
          type: 'obb',
          pos: new Vec2(300, 450),
          halfWidth: 150,
          halfHeight: 20,
          angle: -0.3,
          static: true,
          restitution: 0.4
        }));
        
        world.addBody(new Body({
          dim: '2D',
          type: 'obb',
          pos: new Vec2(900, 450),
          halfWidth: 150,
          halfHeight: 20,
          angle: 0.3,
          static: true,
          restitution: 0.4
        }));
        
        // „ÅÑ„Åè„Å§„Åã„ÅÆÂãïÁöÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        for (let i = 0; i < 5; i++) {
          world.addBody(new Body({
            dim: '2D',
            type: 'circle',
            pos: new Vec2(200 + i * 100, 100 + i * 50),
            radius: 15 + Math.random() * 15,
            restitution: 0.6,
            friction: 0.3
          }));
        }
        
        for (let i = 0; i < 3; i++) {
          world.addBody(new Body({
            dim: '2D',
            type: 'obb',
            pos: new Vec2(700 + i * 80, 100 + i * 60),
            halfWidth: 25,
            halfHeight: 25,
            angle: Math.random() * Math.PI,
            restitution: 0.5,
            friction: 0.4
          }));
        }
      }
      
      // 3D„Ç∑„Éº„É≥„ÅÆÂàùÊúüÂåñ
      function init3D() {
        mode = '3D';
        world = new PhysicsWorld('3D', {
          gravity: new Vec3(0, -980, 0),
          substeps: 4,
          maxIters: 8
        });
        
        // Âú∞Èù¢
        world.addBody(new Body({
          dim: '3D',
          type: 'aabb',
          pos: new Vec3(600, 680, 0),
          halfExt: new Vec3(600, 20, 300),
          static: true,
          restitution: 0.3
        }));
        
        // Â£Å
        world.addBody(new Body({
          dim: '3D',
          type: 'aabb',
          pos: new Vec3(50, 350, 0),
          halfExt: new Vec3(50, 350, 300),
          static: true,
          restitution: 0.3
        }));
        
        world.addBody(new Body({
          dim: '3D',
          type: 'aabb',
          pos: new Vec3(1150, 350, 0),
          halfExt: new Vec3(50, 350, 300),
          static: true,
          restitution: 0.3
        }));
        
        // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†
        world.addBody(new Body({
          dim: '3D',
          type: 'aabb',
          pos: new Vec3(400, 400, 0),
          halfExt: new Vec3(100, 20, 100),
          static: true,
          restitution: 0.4
        }));
        
        world.addBody(new Body({
          dim: '3D',
          type: 'aabb',
          pos: new Vec3(800, 400, 0),
          halfExt: new Vec3(100, 20, 100),
          static: true,
          restitution: 0.4
        }));
        
        // „ÅÑ„Åè„Å§„Åã„ÅÆÂãïÁöÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        for (let i = 0; i < 8; i++) {
          const z = (i % 2) * 100 - 50;
          world.addBody(new Body({
            dim: '3D',
            type: 'sphere',
            pos: new Vec3(200 + i * 80, 100 + i * 40, z),
            radius: 15 + Math.random() * 15,
            restitution: 0.6,
            friction: 0.3
          }));
        }
      }
      
      // ÊèèÁîªÈñ¢Êï∞
      function render2D() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (const body of world.bodies) {
          ctx.save();
          
          if (body.static) {
            ctx.fillStyle = 'rgba(100, 100, 100, 0.8)';
            ctx.strokeStyle = 'rgba(150, 150, 150, 0.9)';
          } else {
            ctx.fillStyle = body.sleeping ? 
              'rgba(100, 150, 255, 0.6)' : 
              'rgba(100, 200, 255, 0.8)';
            ctx.strokeStyle = 'rgba(150, 220, 255, 0.9)';
          }
          ctx.lineWidth = 2;
          
          if (body.type === 'circle') {
            ctx.beginPath();
            ctx.arc(body.pos.x, body.pos.y, body.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // ÂõûËª¢„ÇíÁ§∫„ÅôÁ∑ö
            ctx.beginPath();
            ctx.moveTo(body.pos.x, body.pos.y);
            ctx.lineTo(body.pos.x + body.radius, body.pos.y);
            ctx.stroke();
          } else if (body.type === 'box' || body.type === 'obb') {
            const angle = body.angle || 0;
            ctx.translate(body.pos.x, body.pos.y);
            ctx.rotate(angle);
            ctx.fillRect(-body.halfWidth, -body.halfHeight, 
                        body.halfWidth * 2, body.halfHeight * 2);
            ctx.strokeRect(-body.halfWidth, -body.halfHeight, 
                          body.halfWidth * 2, body.halfHeight * 2);
          }
          
          ctx.restore();
        }
      }
      
      function render3D() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Á∞°ÊòìÁöÑ„Å™3DÊäïÂΩ±ÔºàÁ≠âËßíÊäïÂΩ±È¢®Ôºâ
        const sortedBodies = [...world.bodies].sort((a, b) => a.pos.z - b.pos.z);
        
        for (const body of sortedBodies) {
          ctx.save();
          
          // ZÂ∫ßÊ®ô„Å´Âü∫„Å•„Åè„Çπ„Ç±„Éº„É´„Å®ÊòéÂ∫¶
          const scale = 1 + body.pos.z * 0.001;
          const brightness = 0.7 + body.pos.z * 0.0005;
          
          if (body.static) {
            ctx.fillStyle = `rgba(${100*brightness}, ${100*brightness}, ${100*brightness}, 0.8)`;
            ctx.strokeStyle = `rgba(${150*brightness}, ${150*brightness}, ${150*brightness}, 0.9)`;
          } else {
            ctx.fillStyle = body.sleeping ?
              `rgba(${100*brightness}, ${150*brightness}, ${255*brightness}, 0.6)` :
              `rgba(${100*brightness}, ${200*brightness}, ${255*brightness}, 0.8)`;
            ctx.strokeStyle = `rgba(${150*brightness}, ${220*brightness}, ${255*brightness}, 0.9)`;
          }
          ctx.lineWidth = 2;
          
          const x = body.pos.x + body.pos.z * 0.3;
          const y = body.pos.y - body.pos.z * 0.3;
          
          if (body.type === 'sphere') {
            ctx.beginPath();
            ctx.arc(x, y, body.radius * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // ÂΩ±
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(body.pos.x, 680, body.radius * 1.2, body.radius * 0.5, 0, 0, Math.PI * 2);
            ctx.fill();
          } else if (body.type === 'aabb' || body.type === 'obb3') {
            const hw = body.halfExt.x * scale;
            const hh = body.halfExt.y * scale;
            const hd = body.halfExt.z * scale;
            
            // Á∞°ÊòìÁöÑ„Å™ÁÆ±„ÅÆÊèèÁîªÔºàÁ≠âËßíÊäïÂΩ±È¢®Ôºâ
            ctx.translate(x, y);
            
            // ÂâçÈù¢
            ctx.fillRect(-hw, -hh, hw * 2, hh * 2);
            ctx.strokeRect(-hw, -hh, hw * 2, hh * 2);
            
            // ‰∏äÈù¢ÔºàÊòé„Çã„ÅèÔºâ
            ctx.fillStyle = body.static ?
              `rgba(${120*brightness}, ${120*brightness}, ${120*brightness}, 0.8)` :
              `rgba(${120*brightness}, ${220*brightness}, ${255*brightness}, 0.8)`;
            ctx.beginPath();
            ctx.moveTo(-hw, -hh);
            ctx.lineTo(-hw + hd * 0.5, -hh - hd * 0.3);
            ctx.lineTo(hw + hd * 0.5, -hh - hd * 0.3);
            ctx.lineTo(hw, -hh);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // ÂÅ¥Èù¢ÔºàÊöó„ÅèÔºâ
            ctx.fillStyle = body.static ?
              `rgba(${80*brightness}, ${80*brightness}, ${80*brightness}, 0.8)` :
              `rgba(${80*brightness}, ${180*brightness}, ${235*brightness}, 0.8)`;
            ctx.beginPath();
            ctx.moveTo(hw, -hh);
            ctx.lineTo(hw + hd * 0.5, -hh - hd * 0.3);
            ctx.lineTo(hw + hd * 0.5, hh - hd * 0.3);
            ctx.lineTo(hw, hh);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // ÂΩ±
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(body.pos.x - hw - 10, 680 - 5, hw * 2 + 20, 10);
          }
          
          ctx.restore();
        }
      }
      
      // Êõ¥Êñ∞„É´„Éº„Éó
      function update() {
        if (!isPaused) {
          const now = performance.now();
          const dt = Math.min((now - lastTime) / 1000, 0.033); // ÊúÄÂ§ß33ms
          lastTime = now;
          
          world.step(dt);
          
          // FPSË®àÁÆó
          fps = fps * 0.9 + (1 / dt) * 0.1;
        }
        
        if (mode === '2D') {
          render2D();
        } else {
          render3D();
        }
        
        // Áµ±Ë®àÊõ¥Êñ∞
        document.getElementById('statMode').textContent = mode;
        document.getElementById('statBodies').textContent = world.bodies.length;
        document.getElementById('statFPS').textContent = Math.round(fps);
        document.getElementById('statSubsteps').textContent = world.substeps;
        
        requestAnimationFrame(update);
      }
      
      // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
      btn2D.addEventListener('click', () => {
        init2D();
        btn2D.classList.add('active');
        btn3D.classList.remove('active');
      });
      
      btn3D.addEventListener('click', () => {
        init3D();
        btn3D.classList.add('active');
        btn2D.classList.remove('active');
      });
      
      btnAddCircle.addEventListener('click', () => {
        if (mode === '2D') {
          world.addBody(new Body({
            dim: '2D',
            type: 'circle',
            pos: new Vec2(600, 50),
            radius: 15 + Math.random() * 20,
            restitution: 0.6,
            friction: 0.3
          }));
        } else {
          world.addBody(new Body({
            dim: '3D',
            type: 'sphere',
            pos: new Vec3(600, 50, Math.random() * 100 - 50),
            radius: 15 + Math.random() * 20,
            restitution: 0.6,
            friction: 0.3
          }));
        }
      });
      
      btnAddBox.addEventListener('click', () => {
        if (mode === '2D') {
          world.addBody(new Body({
            dim: '2D',
            type: 'obb',
            pos: new Vec2(600, 50),
            halfWidth: 20 + Math.random() * 20,
            halfHeight: 20 + Math.random() * 20,
            angle: Math.random() * Math.PI,
            restitution: 0.5,
            friction: 0.4
          }));
        } else {
          world.addBody(new Body({
            dim: '3D',
            type: 'aabb',
            pos: new Vec3(600, 50, Math.random() * 100 - 50),
            halfExt: new Vec3(
              15 + Math.random() * 20,
              15 + Math.random() * 20,
              15 + Math.random() * 20
            ),
            restitution: 0.5,
            friction: 0.4
          }));
        }
      });
      
      btnReset.addEventListener('click', () => {
        if (mode === '2D') {
          init2D();
        } else {
          init3D();
        }
      });
      
      btnPause.addEventListener('click', () => {
        isPaused = !isPaused;
        btnPause.textContent = isPaused ? 'Resume' : 'Pause';
      });
      
      // „Éû„Ç¶„Çπ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        
        mouseDown = true;
        mouseStart = { x, y };
      });
      
      canvas.addEventListener('mouseup', (e) => {
        if (!mouseDown) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        
        const dx = x - mouseStart.x;
        const dy = y - mouseStart.y;
        
        if (mode === '2D') {
          world.addBody(new Body({
            dim: '2D',
            type: Math.random() > 0.5 ? 'circle' : 'obb',
            pos: new Vec2(mouseStart.x, mouseStart.y),
            radius: 15 + Math.random() * 15,
            halfWidth: 20,
            halfHeight: 20,
            angle: Math.random() * Math.PI,
            vel: new Vec2(dx * 2, dy * 2),
            restitution: 0.6,
            friction: 0.3
          }));
        } else {
          world.addBody(new Body({
            dim: '3D',
            type: Math.random() > 0.5 ? 'sphere' : 'aabb',
            pos: new Vec3(mouseStart.x, mouseStart.y, 0),
            radius: 15 + Math.random() * 15,
            halfExt: new Vec3(20, 20, 20),
            vel: new Vec3(dx * 2, dy * 2, 0),
            restitution: 0.6,
            friction: 0.3
          }));
        }
        
        mouseDown = false;
      });
      
      canvas.addEventListener('mouseleave', () => {
        mouseDown = false;
      });
      
      // ÂàùÊúüÂåñ„Å®ÈñãÂßã
      init2D();
      update();
    }
  </script>
</body>
</html>
